---
title: "On the Use of Chat GPT and Friends for Research"
subtitle: "EAA Doctoral Colloquium 2024, Bucharest " # we use this for the venue
author: Markus Arnold, Joachim Gassen, and Maximilian Müller
institute: University of Bern, Humboldt-Universität zu Berlin, and University of Cologne
date: today
date-format: "MMMM D, YYYY"
format: 
  beamer: 
    latex_engine: xelatex # pdflatex creates rastered fonts
    slide_level: 3
    
classoption: "aspectratio=169"

header-includes:
- \usepackage{booktabs} 
- \usepackage{tabularx}
- \usepackage{multirow,makecell}
- \usepackage{array}
- \renewcommand\tabularxcolumn[1]{m{#1}}
- \usepackage{makecell}
- \usepackage{colortbl}
- \usepackage{adjustbox}
- \usepackage{tikz}
- \usepackage{siunitx}
- \usepackage{tabu}
- \usetikzlibrary{arrows,arrows.meta,calc,positioning,matrix}
- \input{materials/beamer_theme_trr266_16x9.sty}
- \usepackage{tikz}
- \usepackage{tikzsymbols}
- \usetikzlibrary{calc, shapes, arrows.meta, positioning}
---

```{r setup, include=FALSE, cache=F, message=F, warning=F, results="hide"}
knitr::opts_chunk$set(
  cache = FALSE, echo = FALSE, message = FALSE, warning = FALSE
)

suppressMessages({
  library(tidyverse)
  library(ggbeeswarm)
  library(kableExtra)
  library(modelsummary)
  library(showtext)
	library(ggwordcloud)
	library(tidytext)
	library(gt)
  
  devtools::source_url(
    "https://raw.githubusercontent.com/trr266/treat/main/code/R/theme_trr.R"
  )
})

options(modelsummary_format_numeric_latex = "plain")

# Needs to be 18 for the final experiment
CELL_SIZE <- 18

# Participant groups
LL <- 1:CELL_SIZE
HL <- (CELL_SIZE+1):(2*CELL_SIZE)
HH <- (2*CELL_SIZE+1):(3*CELL_SIZE)

OP_HUMAN <- c(
  rep(c(2, 2), CELL_SIZE), 
  rep(c(1, 2), CELL_SIZE/2), rep(c(2, 1), CELL_SIZE/2), 
  rep(c(1, 1), CELL_SIZE)
)
DEMOG_LEVELS <- c("Extremely", "Very", "Moderately", "Slightly", "Not at all")

rounds <- read_csv("../data/generated/eaadc24_rounds.csv", show_col_types = FALSE) %>%
	mutate(
	  pct_returned = ifelse(sent_amount > 0, sent_back_amount/(3*sent_amount), NA),
	  points_investor = 100 - sent_amount + sent_back_amount,
	  points_manager = 3*sent_amount - sent_back_amount,
	  points_total = points_investor + points_manager 
	 )
part <- read_csv("../data/generated/eaadc24_participants.csv", show_col_types = FALSE) %>%
  mutate(
    passes_cc = as.numeric(comprehension_check == 3),
    remembers_role = as.numeric(manipulation_check == role_in_group),
    guesses_other_participant_type = as.numeric(human_check == OP_HUMAN),
    altruism = factor(altruism, 1:5, labels = DEMOG_LEVELS),
    trust = factor(trust, 1:5, labels = DEMOG_LEVELS),
    reciprocity = factor(reciprocity, 1:5, labels = DEMOG_LEVELS),
    negative_reciprocity = factor(negative_reciprocity, 1:5, labels = DEMOG_LEVELS)
  )

ll_rounds <- rounds %>% filter(group_id %in% LL)
hl_rounds <- rounds %>% filter(group_id %in% HL)
hh_rounds <- rounds %>% filter(group_id %in% HH)
ll_part <- part %>% filter(group_id %in% LL)
hl_part <- part %>% filter(group_id %in% HL)
hh_part <- part %>% filter(group_id %in% HH)

# Needs \usepackage{adjustbox} in preamble
fit_gt_table_to_slide <- function(x, scale = 1) {
	if (scale == 1) repstr <- "\\\\resizebox{\\\\columnwidth}{!}{\\\\begin{tabular}"
	else repstr <- paste0("\\\\resizebox{", scale, "\\\\columnwidth}{!}{\\\\begin{tabular}")
  x <- sub("\\\\begin\\{longtable\\}", repstr, x)
  x <- sub("\\\\end\\{longtable\\}", "\\\\end{tabular}}", x)
  x
}

fit_gt_table_to_slide_long <- function(x, scale = 1) {
	if (scale == 1) repstr <- "\\\\resizebox*{!}{\\\\textheight}{\\\\begin{tabular}"
	else repstr <- paste0("\\\\resizebox*{!}{", scale, "\\\\textheight}{\\\\begin{tabular}")
  x <- sub("\\\\begin\\{longtable\\}", repstr, x)
  x <- sub("\\\\end\\{longtable\\}", "\\\\end{tabular}}", x)
  x
}

center_table <- function(x) {
	x[1] <- paste0("\\begin{center}", x[1], "\\end{center}")
	x
}

star_stat <- function(x, neg = FALSE) {
  if (neg) x$statistic <- -x$statistic 
  paste0(
    format(round(x$statistic, 2), nsmall = 2),
    ifelse(x$p.value < 0.01, "***", ifelse(x$p.value < 0.05, "**", ifelse(x$p.value < 0.1, "*", "")))
  )
}
```

```{r InstallTRRFonts}
trr266_fonts_available <- all(c("Cambria", "Calibri Light") %in% font_families())

if (!trr266_fonts_available) {
  # On Mac with MS Office installation you need to add the Office
  # Fonts to the font path. The following depends on your 
  # installation but _should_ work in most cases
  
  office_font_path <- "/Applications/Microsoft Word.app/Contents/Resources/DFonts"
  if (Sys.info()["sysname"] == "Darwin") {
    if (dir.exists(office_font_path)) font_paths(office_font_path)
    else stop("MS Office font path not found")
  }
  
  rv <- tryCatch({
    font_add(family = "Cambria", regular = "Cambria.ttc")
    font_add(family = "Calibri Light", regular = "calibril.ttf")
  }, error = function(e) {
    message(sprintf("Failed to install TRR 266 fonts: %s", e))
    invisible(font_families())        
  })
  
  trr266_fonts_available <- all(c("Cambria", "Calibri Light") %in% rv)
  if (trr266_fonts_available) message("Successfully installed TRR 266 fonts") 
}
```

## Structure

1. Max: Chat GPT as your research assistant

2. Joachim: Chat GPT as your participant

3. Markus: Chat GPT as your reviewer

## Chat GPT as your Participant

\begin{center}
\includegraphics[height =0.7\textheight]{"materials/eaadc24_qrcode.jpeg"} \\
http://exp.trr266.de/room/eaadc24
\end{center}


## The Experiment

\begin{center}
\includegraphics[height =0.8\textheight]{"materials/eaadc24_otree_inst.jpeg"}
\end{center}


# Chat-GPT 4.0 playing with itself

## Descriptive Statistics by Participant

```{r llDescP}
desc_table_part <- function(df) {
  datasummary(
    (`Points earned`=payoff) + 
      (`Passes comprehension check`=passes_cc) + 
      (`Remembers role`=remembers_role) + 
      (`Guesses nature of other participant correctly`=guesses_other_participant_type)~ 
      (N + (`Mean`= Mean) + (`S.D.` = SD) + (`Median` = Median)), 
    data = df
  )
}
desc_table_part(ll_part)
```


## Messages Sent

```{r llMessage}
messages_table <- function(df) {
  df <- df %>%
    filter(role_in_group == 1) %>%
    select(group_id, group_message) %>%
    rename(ID = group_id, `Message sent` = group_message)
  
  kable(df, booktabs = TRUE, linesep = "") %>%
    kable_styling(full_width = TRUE, font_size = 6) %>% 
    column_spec(1, width = "0.2cm")
}

messages_table(ll_part)
```



## Descriptive Statistics by Round

```{r llDescR}
desc_table_round <- function(df) {
  datasummary(
    (`Amount sent`=sent_amount) + 
      (`Amount returned`=sent_back_amount) + 
      (`% returned`=pct_returned) +
      (`Points Investor`=points_investor) +
      (`Points Manager`=points_manager) +
      (`Points Total`=points_total) ~ 
      (N + (`Mean`= Mean) + (`S.D.` = SD) + (`Median` = Median)), 
    data = df
  )
}

desc_table_round(ll_rounds)
```


## Sent Amount by Round

```{r llRound, fig.width=8, fig.height=3.5, fig.align="center", fig.showtext = TRUE}
plot_send_by_round <- function(df) {
  ggplot(df, aes(x = as.factor(round), y = sent_amount)) +
    geom_beeswarm(size = 0.25, corral = "wrap") +
    stat_summary(
      geom = "smooth",
      fun.data = mean_cl_normal,
      fun.args = list(conf.int = 0.95),
      group = 1,
      alpha = .5,
      color = col_trr266_nightblue,
      fill = col_trr266_iceblue,
      se = TRUE
    ) + 
    labs(x = "Round", y = "") +
    scale_y_continuous(limits = c(0,100)) +
    theme_minimal() +
    theme(
      panel.grid.major.x  = element_blank(),
      panel.grid.minor = element_blank()
    )
}

plot_send_by_round(ll_rounds)
```


# You playing with yourself

## Descriptive Statistics by Participant

```{r hhDescP}
desc_table_part(hh_part)
```


## Messages Sent

```{r hhMessage}
messages_table(hh_part)
```


## Descriptive Statistics by Round

```{r hhDescR}
desc_table_round(hh_rounds)
```


## Sent Amount by Round

```{r hhRound, fig.width=8, fig.height=3.5, fig.align="center", fig.showtext = TRUE}
plot_send_by_round(hh_rounds)
```


# You playing with Chat-GPT 4.0

## Descriptive Statistics by Participant

```{r hlDescP}
desc_table_part(hl_part)
```


## Messages Sent

```{r hlMessage}
messages_table(hl_part)
```


## Descriptive Statistics by Round

```{r hlDescR}
desc_table_round(hl_rounds)
```


## Sent Amount by Round

```{r hlRound, fig.width=8, fig.height=3.5, fig.align="center", fig.showtext = TRUE}
plot_send_by_round(hl_rounds)
```


## Demographics: Altruism

I am willing to help others even if I expect that I will never meet them again.

```{r DemogAltruism, fig.width=8, fig.height=3.5, fig.align="center", fig.showtext = TRUE}
plot_demog_histogram <- function(demog) {
  df <- part %>% filter(!is.na({{demog}}))
  ggplot(df, aes(fill = is_human == 1, group = is_human == 1)) +
    geom_bar(aes(x = {{demog}}),  width=.5, position = "dodge") +
    labs(x = "", y = "", fill = "") +
    scale_x_discrete(drop = FALSE) +
    scale_fill_discrete(labels = c("LLM", "Human")) +
    theme_minimal() + 
    theme(
      panel.grid.major.x  = element_blank(),
      panel.grid.minor = element_blank()
  )
}

plot_demog_histogram(altruism)
```


## Demographics: Trust

I believe that most people can be trusted.

```{r DemogTrust, fig.width=8, fig.height=3.5, fig.align="center", fig.showtext = TRUE}
plot_demog_histogram(trust)
```


## Demographics: Reciprocity

I am willing to incur costs to help someone who has helped me before.

```{r DemogRepr, fig.width=8, fig.height=3.5, fig.align="center", fig.showtext = TRUE}
plot_demog_histogram(reciprocity)
```


## Demographics: Negative Reciprocity

If someone puts me in a difficult position, I would do the same to that person.

```{r DemogNegRepr, fig.width=8, fig.height=3.5, fig.align="center", fig.showtext = TRUE}
plot_demog_histogram(negative_reciprocity)
```

## How does this work? Traditional oTree Setup

\begin{center}
\begin{tikzpicture}[
    block/.style={rectangle, draw, text width=5em, text centered, minimum height=4em},
    line/.style={draw, -Latex},
    every node/.append style={
        execute at end node={\strut},
    }
]

% Blocks
\node[block] (otree) {oTree};
\node[block, right=2cm of otree] (webpages) {Webpages};
\node[right=2cm of webpages] (participants) {\Strichmaxerl[4]}  {};
\node[left=2cm of otree] (researcher){\Strichmaxerl[4]} {};

% Lines
\draw[line] ($(researcher.east)!0.5!(researcher.north east)$) -- node[above] {Design} ($(otree.west)!0.5!(otree.north west)$);
\draw[line] ($(otree.west)!0.5!(otree.south west)$) -- node[below] {Data} ($(researcher.east)!0.5!(researcher.south east)$);
\draw[line] ($(otree.east)!0.5!(otree.north east)$) -- node[above] {HTTP} ($(webpages.west)!0.5!(webpages.north west)$);
\draw[line] ($(webpages.west)!0.5!(webpages.south west)$) -- node[below] {Response} ($(otree.east)!0.5!(otree.south east)$);
\draw[line, Latex-Latex] (participants) -- (webpages);

% Labels
\node[below=0.1cm of participants] {Human Participants};
\node[below=0.1cm of researcher] {Researcher};

\end{tikzpicture}
\end{center}


## How does this work? oTree + botex

\begin{center}
\begin{tikzpicture}[
    block/.style={rectangle, draw, text width=5em, text centered, minimum height=4em},
    line/.style={draw, -Latex},
    every node/.append style={
        execute at end node={\strut},
    }
]

% Blocks
\node[block] (otree) {oTree};
\node[block, right=2cm of otree] (webpages) {Webpages};
\node[block, above=1cm of webpages] (botex) {botex};
\node[right=2cm of webpages] (participants) {\Strichmaxerl[4]}  {};
\node[block, right=2cm of botex] (llm) {LLM};
\node[left=2cm of otree] (researcher){\Strichmaxerl[4]} {};

% Lines
\draw[line] ($(researcher.east)!0.5!(researcher.north east)$) -- node[above] {Design} ($(otree.west)!0.5!(otree.north west)$);
\draw[line] ($(otree.west)!0.5!(otree.south west)$) -- node[below] {Data} ($(researcher.east)!0.5!(researcher.south east)$);
\draw[line] ($(otree.east)!0.5!(otree.north east)$) -- node[above] {HTTP} ($(webpages.west)!0.5!(webpages.north west)$);
\draw[line] ($(webpages.west)!0.5!(webpages.south west)$) -- node[below] {Response} ($(otree.east)!0.5!(otree.south east)$);
\draw[line, Latex-Latex] (participants) -- (webpages);
\draw[line] ($(webpages.north)!0.5!(webpages.north west)$) -- node[left] {Scrape} ($(botex.south)!0.5!(botex.south west)$);
\draw[line] ($(botex.south)!0.5!(botex.south east)$) -- node[right] {Response} ($(webpages.north)!0.5!(webpages.north east)$);
\draw[line] ($(llm.west)!0.5!(llm.north west)$) -- node[above] {Response} ($(botex.east)!0.5!(botex.north east)$);
\draw[line] ($(botex.east)!0.5!(botex.south east)$) -- node[below] {Prompt} ($(llm.west)!0.5!(llm.south west)$);

% Labels
\node[below=0.1cm of participants] {Human Participants};
\node[below=0.1cm of researcher] {Researcher};

\end{tikzpicture}

\end{center}

## Two Papers

\begin{center}
\includegraphics[height =0.7\textheight]{"materials/mei_xie_yuan_jackson_pnas_2024.jpeg"} \\
Mei, Xie, Yuan, and Jackson (PNAS, 2024)
\end{center}

## Two Papers

\begin{center}
\includegraphics[height =0.7\textheight]{"materials/manning_zhu_horton_arxiv_2024.jpeg"} \\
Manning, Zhu, and Horton (arXiv, 2024)
\end{center}

## And.... 

```{r WinnerWinnerChickenDinner}
set.seed(42)
humans <- part %>% filter(is_human == 1, !is.na(payoff))
winner <- sample(seq_len(nrow(humans)), 1, prob=humans$payoff)
```
\begin{center}
... the lucky winner is: `r substr(humans$participant_id[winner],1, 4)`
\end{center}



## Verification of winner 

\begin{center}
Second part of the winning code: `r substr(humans$participant_id[winner],6, 9)`
\end{center}

